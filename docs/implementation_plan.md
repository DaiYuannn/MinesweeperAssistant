# 扫雷助手前端交互与窗口逻辑改进实施方案（草案）

本文基于现有 C++/Win32/OpenCV/CMake 工程，明确可交付的改进项与技术方案，供你确认后逐步落地。

## 目标清单（你可勾选）

1) 多方式选择扫雷窗口（提高易用性）
- A. 自动发现：启动后自动扫描当前顶层/可见窗口，识别哪个窗口是扫雷游戏，若唯一命中则直接绑定；若多候选则弹窗列表供选择。
- B. 列表选择：通过一个对话框/列表控件列出候选窗口（标题/类名/进程名/缩略图），用户点击即选定。
- C. 框选选取：按下快捷键进入“拖拽框选模式”，用半透明矩形套住目标窗口（LL mouse hook + overlay 渲染），松开即选定。
- D. 聚焦即选：显示提示，用户切到目标窗口并按下热键（例如 F8）即选定当前前台窗口。

2) 自动识别与跳转（降低操作路径）
- E. 启动即识别：程序启动后自动从“可见窗口”中执行一次识别（图标/标题/像素模式匹配），命中后直接绑定；未命中则进入选择界面。
- F. 窗口变化监测：绑定后监测句柄有效性、最小化/还原、移动/尺寸变化并自动更新捕获区域。

3) UI 顶层与自适应（便于观察）
- G. 置顶显示：程序主窗口设置为顶层（TopMost），支持切换置顶开关。
- H. 自适应尺寸：主窗口支持“跟随被识别窗口”缩放，保证显示区与被捕获图像比例一致（可配置缩放因子）。
- I. 智能布局：主窗口尽量停靠到目标窗口旁边/不遮挡游戏区；支持一键贴靠/恢复。

4) 识别可视化（更直观）
- J. 矩阵渲染：将识别到的网格数字以彩色矩阵叠绘在捕获图像上（0-8配色、未开/旗子/雷图标）。
- K. 网格与高亮：绘制网格线、当前推断的安全格/必雷格高亮，显示计数统计。
- L. 帧率与性能：控制绘制频率（如 10-15 FPS），避免 UI 卡顿。

5) 交互与操作（可扩展）
- M. 热键支持：启动/暂停分析、进入框选模式、置顶开关、截图保存等。
- N. 点击策略：继续保持“默认仅移动鼠标”安全模式，提供“启用自动点击”的显式开关与延时设置。

6) 健壮性与工程化
- O. 权限兼容：捕获失败时退化方案（PrintWindow→BitBlt→DWM 缩略图/桌面复制），记录失败原因。
- P. 日志与诊断：引入轻量日志，控制台/文件输出关键操作与错误码，便于问题定位。
- Q. 配置持久化：保存上次选择的窗口句柄/类名/匹配特征与 UI 偏好设置（JSON/INI）。

## 技术方案与关键点

- 窗口枚举与匹配：EnumWindows + GetWindowText/ GetClassName/ GetWindowThreadProcessId，结合标题关键字（“Minesweeper/扫雷”）、类名、图标哈希、像素模板匹配（OpenCV 模板匹配）综合判定。
- 框选模式：低级鼠标钩子 WH_MOUSE_LL 捕获按下/移动/抬起；覆盖层窗口（分层/透明窗口 WS_EX_LAYERED | WS_EX_TRANSPARENT）绘制半透明矩形，拾取矩形中心点的 WindowFromPoint/RealChildWindowFromPoint 决定目标；选择后自动 GetAncestor(hwnd, GA_ROOT) 获取顶层窗口。
- 候选列表：简单对话框（CreateDialog + ListView）或直接在主窗口区域渲染列表，显示窗口标题/进程名/缩略图（PrintWindow 缩略采样）。
- 置顶与自适应：SetWindowPos(HWND_TOPMOST/NOTOPMOST)，并订阅目标窗口移动与尺寸变化（轮询 GetWindowRect/ GetClientRect + 比较；或 SetWinEventHook(EVENT_OBJECT_LOCATIONCHANGE) 监听）。根据目标客户区大小计算缩放比例，调整主窗口大小与显示区域。
- 渲染层：保留当前 DisplayWindow，增加一张前景绘制层（GDI 或 GDI+），将捕获到的 BGRA 图像转换为 HBITMAP，再叠加绘制网格线与数字（也可选择 OpenCV 矩阵转 DIB，统一在 GDI 上绘制）。
- 性能：捕获和识别在后台线程；UI 线程仅做轻量拷贝与 BitBlt/StretchBlt；通过双缓冲减少闪烁（已有内存 DC 基础）。控制刷新率以防 CPU 抢占。
- 配置：使用简易 JSON（如 nlohmann/json 或自己写的 minimal INI 读写），持久化窗口选择、置顶开关、缩放因子等。
- 日志：轻量 printf/OutputDebugString 或小型日志库（spdlog 可选）。
- 安全操作：默认禁止实际点击，仅移动鼠标，需用户手动开启“自动点击”，并设定最小延时。

## 交付分期（建议里程碑）

- 里程碑 1（窗口选择与顶层 UI）
  - A/B/D：自动发现 + 列表选择 + 热键聚焦选取
  - G/H：置顶与自适应
  - P：基础日志

- 里程碑 2（框选与渲染）
  - C：框选模式 + 透明覆盖层
  - J/K：网格/数字渲染与高亮
  - L：绘制性能控制

- 里程碑 3（自动识别与跟随）
  - E/F：启动识别、窗口变化监测与自动跟随
  - Q：配置持久化
  - O：捕获退化与报错提示

- 里程碑 4（交互增强）
  - M/N：热键体系与（可选）自动点击开关

## 需要新增/修改的主要文件（初版）

- 新增
  - `src/WindowSelector.h/.cpp`：自动发现、列表选择、框选模式、热键聚焦。
  - `src/OverlayWindow.h/.cpp`：分层透明覆盖层，绘制框选矩形与网格/高亮（也可与 DisplayWindow 合并为可复用控件）。
  - `src/Config.h/.cpp`：配置读写（JSON/INI）。
  - `src/Logger.h/.cpp`：简单日志包装。
- 修改
  - `src/DisplayWindow.*`：置顶开关、自适应尺寸、停靠逻辑、绘制叠加层。
  - `src/WindowCapture.*`：加入窗口变化跟踪，失败回退策略钩子。
  - `src/GameAnalyzer.*`：输出用于渲染的网格/标注数据结构。
  - `src/main.cpp`：启动流程（启动即识别→否则进入选择流程），注册热键，消息循环路由。
- CMake
  - 注册新增源文件；如引入 JSON 库则在 CMakeLists.txt 中检测或改为单头文件引入。

## 验收标准（关键要点）
- 启动自动识别成功率达成（在常见“扫雷”窗口上能命中；不误判其他应用）。
- 窗口选择四种方式至少实现其中三种（自动发现/热键聚焦/列表选择/框选）。
- 主窗口置顶开关有效，且能按目标窗口客户区自适应缩放，保持显示比例不变。
- 渲染正确：数字色彩明晰、网格/高亮不影响背景图细节；在 10 FPS 下 UI 平滑。
- 日志文件记录关键事件，配置开关可保存与恢复。

---
请你确认以上“目标清单 + 技术方案 + 交付分期”。
- 勾选要做的项（或全部接受）。
- 指定优先级（比如先做里程碑 1）。
- 如有偏好的热键与 UI 行为，也请备注。

确认后，我会按约定阶段开始提交代码。