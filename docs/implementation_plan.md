# 扫雷助手前端交互与窗口逻辑改进实施方案（草案）

本文基于现有 C++/Win32/OpenCV/CMake 工程，明确可交付的改进项与技术方案，供你确认后逐步落地。

## 目标清单（你可勾选）

1) 多方式选择扫雷窗口（提高易用性）
## 目标清单（你可勾选）
2) 程序外观与信息展示（无控制台）
2) 程序外观与信息展示（无控制台）
3) 自动识别与跳转（降低操作路径）
3) 自动识别与跳转（降低操作路径）
4) UI 顶层与自适应（便于观察）
4) UI 顶层与自适应（便于观察）
5) 棋盘识别与可视化（核心）
5) 棋盘识别与可视化（核心）
- K. 网格与高亮：绘制网格线、当前推断的安全格/必雷格高亮，显示计数统计。
7) ROI 稳定与网页适配（新增）
- R. ROI 稳定器：相邻帧 IoU 阈值与平滑，避免棋盘区域抖动（网页/远程桌面尤为重要）。
- S. 网格周期性检测：HoughLines/频谱估计网格间距与顶部基线，精确定位棋盘并排除 HUD。
- T. HUD 感知裁剪：优先利用顶部计时器/地雷数（红色七段数码管）定位 HUD 边界，失败再回退边缘投影。
- U. 浏览器抓取诊断：显示 Capture=PW/BitBlt，内容方差校验回退策略，必要时提示关闭硬件加速。
6) 交互与操作（可扩展）
- N. 点击策略：继续保持“默认仅移动鼠标”安全模式，提供“启用自动点击”的显式开关与延时设置。

6) 健壮性与工程化
- O. 权限兼容：捕获失败时退化方案（PrintWindow→BitBlt→DWM 缩略图/桌面复制），记录失败原因。
## 交付分期（建议里程碑，按新需求调整，优化制作顺序）
- 里程碑 3（棋盘识别与网格展示）
  - 棋盘区域检测与解析（格子大小/布局识别），提取每格状态（未开/旗子/数字）
  - 网格化展示当前棋盘与基础高亮（安全格/必雷格）
  - 吸附：窗口吸附到棋盘附近（已完成基础版），优化位置/不遮挡
  - 验收：不同缩放/网页/远程桌面对棋盘识别通过率、错误率与性能（≥10 FPS 分析刷新）
  - 扩展：ROI 稳定器、HUD 感知裁剪、网格周期性检测（网页场景优先）
- 窗口枚举与匹配：EnumWindows + GetWindowText/ GetClassName/ GetWindowThreadProcessId，结合标题关键字（“Minesweeper/扫雷”）、类名、图标哈希、像素模板匹配（OpenCV 模板匹配）综合判定。
- 里程碑 4（无控制台与状态栏/设置入口）
  - 将入口从 main 切换到 WinMain，移除控制台；保留日志到文件
  - 在程序窗口顶部实现状态栏，实时显示目标窗口信息与识别状态（标题/类名/进程、客户区尺寸、FPS、识别耗时/成功率）
  - 添加设置入口（占位 UI），后续用于自定义热键
  - 验收：程序不再弹出 cmd；状态栏实时更新不卡顿；设置入口可打开
- 性能：捕获和识别在后台线程；UI 线程仅做轻量拷贝与 BitBlt/StretchBlt；通过双缓冲减少闪烁（已有内存 DC 基础）。控制刷新率以防 CPU 抢占。
  - 双缓冲：WM_ERASEBKGND 抑制、内存 DC 合成后一次 BitBlt（已落地）。
- 里程碑 5（求解与自动操作扩展）
  - 基础求解引擎：确定性规则推导下一步（单点/双数/边缘集等）
  - 单步指导或自动点击（仍默认关闭），提供延时与安全开关
  - 性能与鲁棒性调优，适配经典客户端/网页/远程桌面
  - 验收：在公开测试盘面上给出正确建议；自动点击可精确命中（在开启时）

- 里程碑 6（热键自定义与配置）
  - 设置页支持自定义热键（进入框选、重识别、开始/暂停分析、截图、开关自动点击等）
  - 配置持久化（JSON/INI），启动时加载
  - 验收：快捷键可被修改并即时生效，重启后仍保留

- 里程碑 7（跟随与健壮性）
  - 目标窗口变化跟随（位置/尺寸改变重算棋盘区域）
  - 捕获失败的回退策略与错误提示（PrintWindow→BitBlt→桌面复制）
  - 打包与依赖处理（OpenCV DLL 等），日志文件轮替
  - 验收：常见边界场景稳定运行，无崩溃，问题可定位
## 交付分期（建议里程碑，按新需求调整）

- 里程碑 1（窗口选择与顶层 UI）
  - A/B/D：自动发现 + 列表选择 + 热键聚焦选取
  - G/H：置顶与自适应
  - P：基础日志

- 里程碑 2（选择行为与小窗模式稳定）
  - C：修复框选模式（遮罩自动退出、不选自身、松开即选中）
  - E：自动识别增强（跳过资源管理器顶层，扩展关键字覆盖网页/远程桌面）
  - H：默认小窗 260x480，不自动匹配目标尺寸

- 里程碑 3（棋盘识别与网格展示）
  - 棋盘区域检测与解析（格子大小/布局识别），提取每格状态（未开/旗子/数字）
  - 网格化展示当前棋盘与基础高亮（安全格/必雷格）
  - 吸附：窗口吸附到棋盘附近（已完成基础版），优化位置/不遮挡

- 里程碑 4（无控制台与状态栏/设置入口）
  - 将入口从 main 切换到 WinMain，移除控制台；保留日志到文件
  - 在程序窗口顶部实现状态栏，实时显示目标窗口信息与识别状态
  - 添加设置入口（占位 UI），后续用于自定义热键

- 里程碑 5（求解与自动操作扩展）
  - 基础求解引擎：确定性规则推导下一步（单点/双数/边缘集等）
  - 单步指导或自动点击（仍默认关闭），提供延时与安全开关
  - 性能与鲁棒性调优，适配经典客户端/网页/远程桌面

- 里程碑 3（自动识别与跟随）
  - E/F：启动识别、窗口变化监测与自动跟随
  - Q：配置持久化
  - O：捕获退化与报错提示

- 里程碑 4（交互增强）
  - M/N：热键体系与（可选）自动点击开关

## 需要新增/修改的主要文件（初版）

- 新增
  - `src/WindowSelector.h/.cpp`：自动发现、列表选择、框选模式、热键聚焦。
  - `src/OverlayWindow.h/.cpp`：分层透明覆盖层，绘制框选矩形与网格/高亮（也可与 DisplayWindow 合并为可复用控件）。
  - `src/Config.h/.cpp`：配置读写（JSON/INI）。
  - `src/Logger.h/.cpp`：简单日志包装。
- 修改
  - `src/DisplayWindow.*`：置顶开关、自适应尺寸、停靠逻辑、绘制叠加层。
  - `src/WindowCapture.*`：加入窗口变化跟踪，失败回退策略钩子。
  - `src/GameAnalyzer.*`：输出用于渲染的网格/标注数据结构。
  - `src/main.cpp`：启动流程（启动即识别→否则进入选择流程），注册热键，消息循环路由。
- CMake
  - 注册新增源文件；如引入 JSON 库则在 CMakeLists.txt 中检测或改为单头文件引入。

## 验收标准（关键要点）
- 启动自动识别成功率达成（在常见“扫雷”窗口上能命中；不误判其他应用）。
- 窗口选择四种方式至少实现其中三种（自动发现/热键聚焦/列表选择/框选）。
- 主窗口置顶开关有效，且能按目标窗口客户区自适应缩放，保持显示比例不变。
- 渲染正确：数字色彩明晰、网格/高亮不影响背景图细节；在 10 FPS 下 UI 平滑。
- 日志文件记录关键事件，配置开关可保存与恢复。

---
请你确认以上“目标清单 + 技术方案 + 交付分期”。

确认后，我会按约定阶段开始提交代码。

---

## 多尺寸/多格数自动识别与触发（新增方案与现状）

- 触发条件：
  - 每帧从上部 35% HUD 区域提取“计时器签名”（HSV 红色掩膜→缩放二值→FNV-1a 64bit），首次或签名变化即触发一次网格重识别。
- 棋盘区域细化：
  - `RefineBoardArea` 优先用红色七段数码管确定 HUD 底边（上边界），失败回退到边缘水平投影；输出 `gridRect`。
- 网格周期与行列数：
  - `AnalyzeGridLayoutEx` 在收缩内区做 Canny + 水平/垂直投影，自相关估计周期，按周期数近似得到 `rows/cols`，并对齐到周期边界得到 `innerRect`。
- 集成路径：
  - `AnalysisThread` 中在 HUD 变化或首次进入时运行 `AnalyzeGridLayoutEx`，更新 `state.rows/cols` 与 ROI；状态栏显示 Grid 与单元像素大小。
- 后续改进：
  - `RefineBoardArea` 增加纵向投影精裁剪左右边界，提高周期估计精准度与点击映射稳定性。

### 文档更新（本次变更）

- 新增 HUD 计时器签名：ExtractHudTimerSignature / HasHudChanged，用于触发重识别。
- 增强 RefineBoardArea：在 HUD 剔除后加入纵向边缘投影，输出更精确左右边界。
- 新增 AnalyzeGridLayoutEx：通过投影+自相关估计周期与行列数，并对齐到周期边界得到 innerRect。